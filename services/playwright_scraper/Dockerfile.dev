FROM golang:1.23-bookworm

WORKDIR /app

# Install system dependencies for Playwright + Node.js for codegen
RUN apt-get update && apt-get install -y \
    ca-certificates \
    tzdata \
    chromium \
    docker.io \
    nodejs \
    npm \
    && rm -rf /var/lib/apt/lists/*

# Install @playwright/test globally so npx playwright codegen works
RUN npm install -g @playwright/test

# Copy module files
COPY services/playwright_scraper/go.mod services/playwright_scraper/go.sum ./
RUN go mod download

# Copy all source files
COPY services/playwright_scraper/*.go ./
COPY services/playwright_scraper/scraper_pkg ./scraper_pkg

# Build binary
RUN go build -o scraper .

# Install Playwright browsers/deps via the binary/library
# (The code does this at startup, but pre-installing deps is good)
RUN go run github.com/playwright-community/playwright-go/cmd/playwright@latest install --with-deps

EXPOSE 8080

CMD ["./scraper"]
