{{ define "tools.html" }}
<div id="tools-panel" style="padding:16px; margin:16px; border:1px solid #ddd; border-radius:8px; background:#fff;">
	<div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:12px;">
		<h2 style="margin:0; font-size:18px;">Tools</h2>
		<div>
			<button id="btn-refresh-tools" style="padding:6px 10px; cursor:pointer;">Refresh</button>
			<button id="btn-refresh-metrics" style="padding:6px 10px; cursor:pointer; margin-left:8px;">Refresh Metrics</button>
			<label style="margin-left:8px; font-size:12px; color:#333;">
				<input type="checkbox" id="tools-filter-agent" /> Show autogenerated only
			</label>
		</div>
	</div>
	<div id="tools-meta" style="font-size:12px; color:#666; margin-bottom:8px;"></div>
	<table id="tools-table" style="width:100%; border-collapse:collapse;">
		<thead>
			<tr>
				<th style="text-align:left; border-bottom:1px solid #eee; padding:8px;">ID</th>
				<th style="text-align:left; border-bottom:1px solid #eee; padding:8px;">Name</th>
				<th style="text-align:left; border-bottom:1px solid #eee; padding:8px;">Description</th>
				<th style="text-align:left; border-bottom:1px solid #eee; padding:8px;">Safety</th>
				<th style="text-align:left; border-bottom:1px solid #eee; padding:8px;">Permissions</th>
				<th style="text-align:left; border-bottom:1px solid #eee; padding:8px;">Calls</th>
				<th style="text-align:left; border-bottom:1px solid #eee; padding:8px;">Success</th>
				<th style="text-align:left; border-bottom:1px solid #eee; padding:8px;">Failure</th>
				<th style="text-align:left; border-bottom:1px solid #eee; padding:8px;">Avg Time</th>
				<th style="text-align:left; border-bottom:1px solid #eee; padding:8px;">Actions</th>
			</tr>
		</thead>
		<tbody></tbody>
	</table>
</div>
<script>
(function(){
	let toolsData = [];
	let metricsData = {};

	async function fetchTools(){
		try{
			const res = await fetch('/api/tools');
			const data = await res.json();
			toolsData = (data && data.tools) || [];
			renderTools();
		} catch(e){
			toolsData = [];
			renderTools();
		}
	}

	async function fetchMetrics(){
		try{
			const res = await fetch('/api/tools/metrics');
			const data = await res.json();
			metricsData = {};
			if (data && data.metrics) {
				data.metrics.forEach(metric => {
					metricsData[metric.tool_id] = metric;
				});
			}
			renderTools();
		} catch(e){
			console.error('Failed to fetch metrics:', e);
		}
	}

	function renderTools(){
		const tbody = document.querySelector('#tools-table tbody');
		const meta = document.getElementById('tools-meta');
		if(!tbody) return;
		tbody.innerHTML = '';
		const agentOnly = document.getElementById('tools-filter-agent')?.checked;
		const filtered = agentOnly ? toolsData.filter(t => String(t.created_by||'').toLowerCase()==='agent') : toolsData;
		meta.textContent = 'Total: ' + filtered.length + ' tools';
		
		for(const t of filtered){
			const metrics = metricsData[t.id] || {
				total_calls: 0,
				success_calls: 0,
				failure_calls: 0,
				avg_duration_ms: 0
			};
			
			const tr = document.createElement('tr');
			tr.innerHTML = `
				<td style="padding:8px; border-bottom:1px solid #f5f5f5;">${escapeHtml(t.id||'')}</td>
				<td style="padding:8px; border-bottom:1px solid #f5f5f5; font-weight:600;">${escapeHtml(t.name||'')}</td>
				<td style="padding:8px; border-bottom:1px solid #f5f5f5;">${escapeHtml(t.description||'')}</td>
				<td style="padding:8px; border-bottom:1px solid #f5f5f5;">${escapeHtml(t.safety_level||'')}</td>
				<td style="padding:8px; border-bottom:1px solid #f5f5f5;">${Array.isArray(t.permissions)? t.permissions.map(escapeHtml).join(', '): ''}</td>
				<td style="padding:8px; border-bottom:1px solid #f5f5f5; text-align:center;">${metrics.total_calls}</td>
				<td style="padding:8px; border-bottom:1px solid #f5f5f5; text-align:center; color:green;">${metrics.success_calls}</td>
				<td style="padding:8px; border-bottom:1px solid #f5f5f5; text-align:center; color:red;">${metrics.failure_calls}</td>
				<td style="padding:8px; border-bottom:1px solid #f5f5f5; text-align:center;">${Math.round(metrics.avg_duration_ms)}ms</td>
				<td style="padding:8px; border-bottom:1px solid #f5f5f5; text-align:right; white-space:nowrap;">
					<button class="btn" data-tool-id="${escapeHtml(t.id||'')}">Invoke</button>
					${String(t.created_by||'').toLowerCase()==='agent' ? `<button class="btn btn-danger" data-tool-del="${escapeHtml(t.id||'')}" style="margin-left:6px;">Delete</button>` : ''}
				</td>
			`;
			tbody.appendChild(tr);
		}
		// Wire delete buttons (proxy via Monitor)
		tbody.querySelectorAll('button[data-tool-del]').forEach(btn => {
			btn.addEventListener('click', async (e) => {
				const id = btn.getAttribute('data-tool-del');
				if (!id) return;
				if (!confirm(`Delete tool ${id}?`)) return;
				try{
					const res = await fetch(`/api/tools/${encodeURIComponent(id)}`, { method: 'DELETE' });
					if (!res.ok) throw new Error('delete failed');
				}catch(_){ /* ignore */ }
				fetchTools();
			});
		});
	}

	function escapeHtml(s){
		return String(s).replace(/[&<>"']/g, function(c){
			return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c]);
		});
	}

	document.getElementById('btn-refresh-tools')?.addEventListener('click', fetchTools);
	document.getElementById('btn-refresh-metrics')?.addEventListener('click', fetchMetrics);
	document.getElementById('tools-filter-agent')?.addEventListener('change', renderTools);
	
	// Initial load
	fetchTools();
	fetchMetrics();
	
	// Auto-refresh metrics every 30 seconds
	setInterval(fetchMetrics, 30000);
})();
</script>
{{ end }}

