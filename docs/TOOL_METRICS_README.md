# Tool Metrics and Logging System

This document describes the comprehensive tool call logging and metrics system implemented for the Artificial Mind platform.

## Overview

The tool metrics system provides:
- **Detailed logging** of all tool calls to `/tmp` directory
- **Real-time metrics** stored in Redis
- **Live dashboard** updates in the Tools pane
- **API endpoints** for programmatic access to metrics

## Features

### 1. Comprehensive Logging
- **File logging**: All tool calls are logged to `/tmp/tool_calls_YYYY-MM-DD.log`
- **Structured data**: Each log entry contains:
  - Tool ID and name
  - Parameters passed to the tool
  - Execution status (success/failure/blocked)
  - Duration in milliseconds
  - Agent and project IDs
  - Response data
  - Permissions and safety level

### 2. Redis Metrics Storage
- **Aggregated statistics** for each tool:
  - Total calls
  - Success/failure counts
  - Average execution time
  - Last called timestamp
- **Recent calls list** (last 100 calls with 7-day TTL)
- **Individual call logs** (7-day TTL)

### 3. Real-time Dashboard
- **Tools pane** shows live metrics
- **Auto-refresh** every 30 seconds
- **Color-coded** success/failure indicators
- **Sortable columns** for easy analysis

## API Endpoints

### Get All Tool Metrics
```bash
GET /api/v1/tools/metrics
```
Returns aggregated metrics for all tools.

**Response:**
```json
{
  "metrics": [
    {
      "tool_id": "tool_http_get",
      "tool_name": "HTTP GET",
      "total_calls": 15,
      "success_calls": 14,
      "failure_calls": 1,
      "blocked_calls": 0,
      "avg_duration_ms": 1250.5,
      "last_called": "2024-01-15T10:30:00Z",
      "created_at": "2024-01-15T09:00:00Z"
    }
  ],
  "count": 1
}
```

### Get Specific Tool Metrics
```bash
GET /api/v1/tools/{tool_id}/metrics
```
Returns metrics for a specific tool.

### Get Recent Tool Calls
```bash
GET /api/v1/tools/calls/recent?limit=50
```
Returns recent tool calls (default limit: 50).

**Response:**
```json
{
  "calls": [
    {
      "id": "tool_call_1234567890",
      "tool_id": "tool_http_get",
      "tool_name": "HTTP GET",
      "parameters": {"url": "https://example.com"},
      "status": "success",
      "duration": 1250,
      "agent_id": "agent_123",
      "project_id": "project_456",
      "timestamp": "2024-01-15T10:30:00Z",
      "response": {"status": 200, "body": "..."},
      "permissions": ["net:read"],
      "safety_level": "low"
    }
  ],
  "count": 1
}
```

## Log File Format

Tool calls are logged to `/tmp/tool_calls_YYYY-MM-DD.log` with the following format:

```
[2024-01-15T10:30:00Z] {"id":"tool_call_1234567890","tool_id":"tool_http_get","tool_name":"HTTP GET","parameters":{"url":"https://example.com"},"status":"success","duration":1250,"agent_id":"agent_123","project_id":"project_456","timestamp":"2024-01-15T10:30:00Z","response":{"status":200,"body":"..."},"permissions":["net:read"],"safety_level":"low"}
```

## Dashboard Usage

1. **Open the monitor UI**: Navigate to `http://localhost:3000`
2. **Go to Tools section**: The Tools pane shows all registered tools
3. **View metrics**: Each tool displays:
   - Total calls
   - Success count (green)
   - Failure count (red)
   - Average execution time
4. **Refresh data**: Click "Refresh Metrics" or wait for auto-refresh
5. **Filter tools**: Use "Show autogenerated only" checkbox

## Configuration

The tool metrics system is automatically initialized when the HDN server starts:

```go
// In hdn/api.go
toolMetrics, err := NewToolMetricsManager("localhost:6379", "/tmp")
```

**Configuration options:**
- **Redis address**: Default `localhost:6379`
- **Log directory**: Default `/tmp`
- **Metrics TTL**: Indefinite (stored permanently)
- **Call logs TTL**: 7 days
- **Recent calls limit**: 100 calls

## Monitoring and Alerts

### Key Metrics to Monitor
- **High failure rates**: Tools with >20% failure rate
- **Slow tools**: Tools with >5s average execution time
- **Blocked calls**: Tools frequently blocked by principles
- **Unused tools**: Tools with zero calls

### Log Analysis
```bash
# Count total tool calls today
grep "$(date +%Y-%m-%d)" /tmp/tool_calls_*.log | wc -l

# Find failed tool calls
grep '"status":"failure"' /tmp/tool_calls_*.log

# Analyze tool usage patterns
grep '"tool_id":"tool_http_get"' /tmp/tool_calls_*.log | jq '.duration' | sort -n
```

## Testing

Run the test script to verify the system:

```bash
./test_tool_metrics.sh
```

This will:
1. Check if the HDN server is running
2. Test the metrics endpoints
3. Invoke a tool to generate metrics
4. Verify the log file is created
5. Display the results

## Troubleshooting

### Common Issues

1. **Metrics not showing**: Check if Redis is running and accessible
2. **Log file not created**: Verify `/tmp` directory is writable
3. **Dashboard not updating**: Check browser console for JavaScript errors
4. **API errors**: Verify the HDN server is running on port 8080

### Debug Commands

```bash
# Check Redis metrics
redis-cli keys "tool_metrics:*"

# View recent calls
redis-cli lrange "tool_calls:recent" 0 10

# Check log file
tail -f /tmp/tool_calls_$(date +%Y-%m-%d).log
```

## Architecture

The system consists of:

1. **ToolMetricsManager**: Core component handling logging and metrics
2. **ResponseWrapper**: HTTP response interceptor for capturing responses
3. **API Handlers**: REST endpoints for metrics retrieval
4. **Frontend Integration**: JavaScript updates for real-time display

## Future Enhancements

- **Alerting system** for high failure rates
- **Performance trends** and historical analysis
- **Tool usage recommendations** based on patterns
- **Export functionality** for metrics data
- **Integration with external monitoring** systems
